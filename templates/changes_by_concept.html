<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>盘口异动</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Umbrella JS -->
    <script src="https://cdn.jsdelivr.net/npm/umbrellajs"></script>
    <script>
        // Function to load and display data
        function loadData() {
            fetch('http://0.0.0.0:61125/api/changes/json', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(function(response) {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(function(data) {
                if (data && data.length > 0) {
                    const concepts = {};
                    data.forEach(item => {
                        const conceptName = item["板块名称"];
                        if (!concepts[conceptName]) {
                            concepts[conceptName] = { "上午": {}, "下午": {} };
                        }
                        
                        const time = item["时间"];
                        const name = item["名称"];
                        const roundedValue = item["四舍五入取整"];
                        const type = item["类型"];

                        let valueStr = roundedValue > 0 ? `+${roundedValue}` : roundedValue;

                        if (type === "封涨停板") {
                            valueStr = `<span class='text-red-600'>${valueStr}</span>`;
                        }

                        const info = `<span>${name} ${valueStr}</span>`;
                        const period = item["上下午"];

                        if (period === "上午" || period === "下午") {
                            if (!concepts[conceptName][period][time]) {
                                concepts[conceptName][period][time] = [];
                            }
                            concepts[conceptName][period][time].push(info);
                        }
                    });

                    let tableBodyHtml = '';
                    for (const conceptName in concepts) {
                        let rowHtml = '<tr>';
                        rowHtml += `<td class="p-2 font-semibold align-top border">${conceptName}</td>`;

                        for (const period of ["上午", "下午"]) {
                            let periodHtml = '<td class="p-2 align-top border">';
                            const timeGroups = concepts[conceptName][period];
                            const sortedTimes = Object.keys(timeGroups).sort();

                            for (const time of sortedTimes) {
                                const stocks = timeGroups[time].join(', ');
                                periodHtml += `<p>${time} ${stocks}</p>`;
                            }
                            periodHtml += '</td>';
                            rowHtml += periodHtml;
                        }

                        rowHtml += '</tr>';
                        tableBodyHtml += rowHtml;
                    }
                    
                    u('#concepts-body').html(tableBodyHtml);
                    
                    // Show table and hide loading message
                    u('#loading').addClass('hidden');
                    u('#data-container').removeClass('hidden');
                } else {
                    u('#loading').html('No data available');
                }
            })
            .catch(function(error) {
                console.error('Error loading data:', error);
                u('#loading').html('Error loading data. Please try again later.');
            });
        }
        
        // Check if current time is within Chinese stock market hours (Mon-Fri, 9:30-11:30, 13:00-15:00 Beijing Time)
        function isTradingHours() {
            // 使用toLocaleString获取北京时间
            const options = { 
                timeZone: 'Asia/Shanghai',
                hour: 'numeric',
                minute: 'numeric',
                weekday: 'long',
                hour12: false
            };
            
            const now = new Date();
            const beijingTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Shanghai' }));
            const day = beijingTime.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            const hours = beijingTime.getHours();
            const minutes = beijingTime.getMinutes();
            const currentMinutes = hours * 60 + minutes;
            
            // 添加调试信息
            console.log('Beijing Time:', beijingTime);
            console.log('Day:', day, 'Time:', hours + ':' + minutes);
            
            // Check if it's a weekday (1-5) and within market hours
            const isTrading = day >= 1 && day <= 5 && // Monday to Friday
                             ((currentMinutes >= 9 * 60 + 30 && currentMinutes < 11 * 60 + 30) || // 9:30-11:30
                              (currentMinutes >= 13 * 60 && currentMinutes < 15 * 60)); // 13:00-15:00
            
            console.log('Is trading hours:', isTrading);
            return isTrading;
        }
        
        // Load data when page loads and set up auto-refresh
        document.addEventListener('DOMContentLoaded', function() {
            function checkAndLoadData() {
                if (isTradingHours()) {
                    u('#loading').removeClass('hidden').html('正在更新数据...');
                    u('#data-container').addClass('hidden');
                    loadData();
                } else {
                    u('#loading').removeClass('hidden').html('当前非交易时间（交易时间：周一至周五 9:30-11:30, 13:00-15:00 北京时间）');
                    u('#data-container').addClass('hidden');
                }
            }
            
            // Initial load
            checkAndLoadData();
            
            // Set up auto-check every 2 seconds
            setInterval(checkAndLoadData, 2000);
        });
    </script>
</head>
<body class="bg-gray-100 p-6">
    <div class="container mx-auto bg-white rounded-lg shadow-md p-6 max-w-7xl">
        <h1 class="text-2xl font-bold text-gray-800 text-center mb-6">盘口异动</h1>
        <div class="mt-6">
            <div id="loading" class="text-center py-4">Loading data...</div>
            <div id="data-container" class="hidden">
                <table class="w-full text-xs border-collapse table-fixed">
                    <thead>
                        <tr class="bg-amber-100">
                            <th class="p-2 border" style="width: 10%;">板块</th>
                            <th class="p-2 border" style="width: 45%;">上午</th>
                            <th class="p-2 border" style="width: 45%;">下午</th>
                        </tr>
                    </thead>
                    <tbody id="concepts-body" class="divide-y divide-gray-200">
                        <!-- Data will be injected here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>
</html>